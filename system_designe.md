# Gemini検索対応チャットアプリケーション要件定義書（Python+Streamlit版）

## 1. プロジェクト概要

### 1.1 プロジェクト名

Gemini Search Chat

### 1.2 目的

Pythonと Streamlitを使用してGemini APIで検索ができる個人用Webアプリケーションを開発し、OSSとして公開する。日常的な質問に対応するためのシンプルなインターフェースを提供する。

### 1.3 主要なステークホルダーと対象ユーザー

- 開発者自身
- このOSSを利用する他の開発者（インストールする人）

### 1.4 プロジェクトの背景と解決すべき問題

- Gemini APIを使った検索機能を持つ自分用チャットアプリケーションの構築
- プロジェクト単位での会話コンテキスト管理
- カスタマイズ可能なシステムプロンプト設定
- 使用するGeminiモデルの切り替え機能
- 会話履歴の保存と管理
- 複数のスレッド（チャットセッション）の管理
- 会話履歴のエクスポート機能

### 1.5 成功基準と期待される結果

- シンプルで使いやすいUI/UX（Streamlitベース）
- プロジェクト単位でのシステムプロンプト設定と会話管理
- プロジェクト単位での使用モデル設定機能
- 複数のスレッドで会話履歴を管理できる機能
- SQLiteによるローカルでのデータ保存
- 会話履歴を適切な形式でエクスポートできる機能
- ローカル環境での簡単な実行/セットアップ

## 2. 機能要件

### 2.1 プロジェクト管理機能

- プロジェクトの作成、編集、削除
- プロジェクト一覧表示
- プロジェクト切り替え機能
- プロジェクトごとのシステムプロンプト設定
- プロジェクトごとのスレッド管理
- プロジェクトごとの使用Geminiモデル設定（gemini-2.0-flash, gemini-2.0-pro-exp-02-05, gemini-2.5-pro-exp-03-25）

### 2.2 スレッド管理機能

- プロジェクト内での新規スレッド（チャットセッション）の作成
- スレッド一覧の表示
- スレッドの選択と切り替え
- スレッドの削除
- スレッド名の編集

### 2.3 チャット機能

- テキスト入力によるGemini APIへの質問送信
- プロジェクトごとのシステムプロンプトをコンテキストに適用
- プロジェクトで設定されたGeminiモデルを使用
- Gemini APIからの回答表示
- マークダウン形式での回答レンダリング
- コードブロックの適切な表示（シンタックスハイライト対応）
- 長文回答のスクロール表示

### 2.4 検索機能

- Gemini APIを用いた検索クエリの処理（プロジェクト設定モデルを使用）
- 検索結果の表示とマークダウン対応
- 検索の文脈を維持したチャット継続

### 2.5 履歴管理機能

- プロジェクト・スレッドごとの会話履歴の自動保存
  - SQLiteデータベースへの保存
  - マークダウンファイルへのリアルタイム書き出し（スレッドごとに1ファイル）
- 過去の会話履歴の閲覧
- マークダウンファイルの確認機能
- SQLite FTS5を使用したチャット履歴の全文検索機能
  - 半角スペースで区切られた複数キーワードによる検索
  - 複数キーワードを含むスレッドを検索可能

### 2.6 エクスポート機能

- 全データのCSV形式でのエクスポート
- 既存のマークダウンファイルの確認機能（スレッドごとのリアルタイム保存ファイル）

## 3. 非機能要件

### 3.1 パフォーマンス要件

- ページロード時間：3秒以内
- Gemini API応答待ち時間のローディング表示
- スムーズなスクロールとページ遷移

### 3.2 セキュリティ要件

- Gemini API キーの安全な管理（環境変数使用）
- ローカルのみで動作するアプリケーションのため、追加的な認証は不要

### 3.3 可用性と信頼性

- オフライン時のエラーハンドリング
- APIリクエスト失敗時の適切なエラーメッセージ表示
- データベース操作エラーの適切な処理

### 3.4 スケーラビリティとメンテナンス性

- モジュール化された設計による拡張性の確保
- 明確なコードドキュメントとコメント
- Pythonコーディング規約（PEP 8）に準拠した実装

## 4. アーキテクチャ設計

### 4.1 システム構成図

```
+---------------------+     +----------------+     +------------------+
| Streamlit App       |<--->| SQLAlchemy     |<--->| SQLite Database  |
| (Frontend/Backend)  |     | (Data Access)  |     | (Local Storage)  |
+---------------------+     +----------------+     +------------------+
        |                          |                        |
        |                          v                        |
        |                   +----------------+              |
        |                   | SQLite FTS5    |<-------------+
        |                   | Search Engine  |
        |                   +----------------+
        v
+---------------------+     +------------------+
| File System         |     | Gemini API       |
| (Markdown Files)    |     | (External Service)|
+---------------------+     +------------------+
```

### 4.2 コンポーネント間の依存関係

- Streamlitアプリがフロントエンドとバックエンドの両方を提供
- データアクセスレイヤー（SQLAlchemy）がSQLiteデータベースとの通信を担当
- エクスポートサービスがファイルシステムへの書き出しを担当
- Google API Clientを使用してGemini APIとの通信を行う

### 4.3 外部システムとのインターフェース

- Gemini API: Google APIクライアントライブラリを使用して検索クエリを送信し結果を受信

## 5. データモデル

### 5.1 ER図

```
+----------------+       +-----------------+       +-------------------+       +-------------------+
| Project        |       | Thread          |       | Message           |       | MessageFTS        |
+----------------+       +-----------------+       +-------------------+       +-------------------+
| id (PK)        |<------| id (PK)         |<----->| id (PK)           |<----->| rowid (PK)        |
| name           |       | project_id (FK) |       | thread_id (FK)    |       | content           |
| system_prompt  |       | name            |       | role              |       +-------------------+
| model_name     |       | created_at      |       | content           |
| created_at     |       | updated_at      |       | created_at        |
| updated_at     |       +-----------------+       +-------------------+
+----------------+
```

### 5.2 データディクショナリ

#### Project テーブル (SQLAlchemy Model)

| フィールド名    | 型      | 制約        | 説明                      |
|---------------|---------|------------|--------------------------|
| id            | INTEGER | PRIMARY KEY| プロジェクトの一意識別子      |
| name          | TEXT    | NOT NULL   | プロジェクト名              |
| system_prompt | TEXT    | NOT NULL   | システムプロンプト設定       |
| model_name    | TEXT    | NOT NULL   | 使用するGeminiモデル名      |
| created_at    | DATETIME| NOT NULL   | 作成日時                   |
| updated_at    | DATETIME| NOT NULL   | 更新日時                   |

#### Thread テーブル (SQLAlchemy Model)

| フィールド名 | 型      | 制約                      | 説明                      |
|------------|---------|--------------------------|--------------------------|
| id         | INTEGER | PRIMARY KEY              | スレッドの一意識別子          |
| project_id | INTEGER | FOREIGN KEY (Project.id) | 所属するプロジェクトのID       |
| name       | TEXT    | NOT NULL                 | スレッド名                  |
| created_at | DATETIME| NOT NULL                 | 作成日時                    |
| updated_at | DATETIME| NOT NULL                 | 更新日時                    |

#### Message テーブル (SQLAlchemy Model)

| フィールド名 | 型      | 制約                      | 説明                      |
|------------|---------|--------------------------|--------------------------|
| id         | INTEGER | PRIMARY KEY              | メッセージの一意識別子        |
| thread_id  | INTEGER | FOREIGN KEY (Thread.id)  | 所属するスレッドのID         |
| role       | TEXT    | NOT NULL                 | メッセージの役割（'user'/'assistant'/'system'）|
| content    | TEXT    | NOT NULL                 | メッセージの内容             |
| created_at | DATETIME| NOT NULL                 | 作成日時                    |

#### MessageFTS テーブル (SQLite FTS5仮想テーブル)

| フィールド名 | 型      | 制約        | 説明                      |
|------------|---------|------------|--------------------------|
| rowid      | INTEGER | 暗黙的PK     | Message.idと連動する識別子   |
| content    | TEXT    | INDEXED    | 全文検索対象のメッセージ内容   |

### 5.3 データの流れと処理

1. ユーザーがプロジェクトを作成/選択
2. プロジェクト内でスレッドを作成/選択
3. ユーザーがメッセージを入力
4. メッセージがデータベースに保存され、プロジェクトのシステムプロンプトとともにGemini APIに送信
5. 同時に、スレッド専用のマークダウンファイルにメッセージが追記される
6. Gemini APIからの応答がデータベースに保存され、UI上に表示
7. 同様に、マークダウンファイルにGemini APIの応答も追記される
8. 保存されたメッセージはFTS5インデックスにも追加され、検索可能に
9. ユーザーが検索を実行すると、FTS5インデックスを使用して関連メッセージを抽出
10. 「ファイルを確認」ボタンでスレッドに対応するマークダウンファイルを表示/開く
11. 全データエクスポート時にはデータベースからデータを取得し、CSV形式に変換して出力

## 6. ユーザーインターフェース

### 6.1 画面構成

Streamlitは単一ページアプリケーションの構造を持つため、サイドバーでナビゲーションを提供し、メインエリアで各機能を表示する設計とする。

```
+----------------------------------+------------------------------------------+
| サイドバー                        | メインコンテンツエリア                      |
|                                  |                                          |
| - プロジェクト選択ドロップダウン     | [プロジェクト管理ビュー]                   |
| - 現在のプロジェクト情報           | - プロジェクト一覧                         |
| - スレッド選択リスト              | - プロジェクト作成/編集フォーム              |
| - 新規スレッド作成ボタン          |                                          |
| - 検索機能                       | [スレッド管理ビュー]                       |
| - エクスポート機能               | - スレッド一覧                            |
| - 設定メニュー                   | - スレッド作成/編集フォーム                 |
|                                 |                                          |
|                                 | [チャットビュー]                           |
|                                 | - メッセージ履歴表示                       |
|                                 | - メッセージ入力フォーム                    |
|                                 | - 送信ボタン                              |
|                                 |                                          |
|                                 | [検索結果ビュー]                          |
|                                 | - 検索結果一覧                            |
|                                 | - スレッドプレビュー                       |
|                                 |                                          |
|                                 | [設定ビュー]                             |
|                                 | - API設定                                |
|                                 | - エクスポート設定                         |
|                                 | - アプリ情報                              |
+----------------------------------+------------------------------------------+
```

### 6.2 各画面の主要要素と機能

#### ホーム/プロジェクト選択画面

- プロジェクト一覧表示（カード形式）
- 新規プロジェクト作成ボタン
- プロジェクト検索/フィルターフォーム
- 各プロジェクトカードにはプロジェクト名、作成日時、スレッド数を表示

#### プロジェクト作成/編集画面

- プロジェクト名入力フォーム
- システムプロンプト入力フォーム（マークダウンエディタ）
- Geminiモデル選択ドロップダウン
- プリセットテンプレート選択オプション
- 保存ボタン
- キャンセルボタン

#### スレッド一覧画面

- スレッド一覧表示（カード形式またはリスト形式）
- 新規スレッド作成ボタン
- 各スレッドカードにはスレッド名、最終更新日時、メッセージ数を表示
- スレッド削除ボタン

#### チャット画面

- プロジェクト名表示
- スレッド名表示
- メッセージ履歴表示領域（スクロール可能）
- メッセージ入力フォーム
- 送信ボタン
- マークダウンファイルを確認するボタン

#### 検索画面

- 検索キーワード入力フォーム
- 検索範囲選択（全プロジェクト/現在のプロジェクト）
- 検索実行ボタン
- 検索結果一覧（プロジェクト名、スレッド名、日付、メッセージプレビュー付き）
- 検索結果をクリックして該当スレッドとメッセージを表示

#### 設定画面

- Gemini API設定
- 全データエクスポートボタン（CSV形式）
- データリセットボタン
- マークダウンファイル保存ディレクトリ設定
- バージョン情報

### 6.3 ユーザー操作フロー

1. アプリケーション起動
2. サイドバーでプロジェクトを選択または新規作成
3. 新規プロジェクト作成時はシステムプロンプトとGeminiモデルを設定
4. プロジェクト内でスレッドを選択または新規作成
5. チャット画面でメッセージを入力
6. 送信ボタンをクリックしてメッセージを送信（プロジェクトのシステムプロンプトが自動的に適用される）
7. 応答を確認し、必要に応じて会話を継続
8. 必要に応じて「マークダウンファイルを確認」ボタンでスレッドの履歴ファイルを表示
9. サイドバーから同一プロジェクト内で新しいスレッドに切り替え、または別のプロジェクトに移動
10. サイドバーの検索機能を使用して過去の会話を検索
11. 設定画面にアクセスして各種設定を変更

## 7. 実装仕様

### 7.1 Gemini API連携

#### Gemini API呼び出し

- Google API Clientライブラリを使用
- 環境変数から取得したAPI Keyを使用
- システムプロンプトと会話履歴を適切に構造化して送信
- ストリーミングレスポンスのサポート（可能な場合）

#### モデル選択

- `gemini-2.0-flash`
- `gemini-2.0-pro-exp-02-05`
- `gemini-2.5-pro-exp-03-25`
- 将来の新しいモデルにも対応できる拡張性を確保

### 7.2 データベース処理

- SQLAlchemyを使用したORMマッピング
- SQLite FTS5による全文検索実装
- トランザクション管理によるデータ整合性の確保
- バックアップ機能の実装

### 7.3 マークダウンファイル処理

- スレッドごとにマークダウンファイルを自動生成
- メッセージ追加時にリアルタイムでファイル更新
- ファイル操作のエラーハンドリング
- 外部エディタでのファイルオープン機能

### 7.4 エクスポート機能

- 全データのCSV形式へのエクスポート
- スレッドごとのマークダウンファイルのエクスポート
- エクスポート処理のエラーハンドリング

### 7.5 エラーハンドリングと例外処理

- API通信エラー時の再試行ロジック
- ユーザーへのエラー通知メカニズム
- データベースエラーのロギングと回復処理
- 検索クエリ構文エラーの適切な処理と通知
- 検索結果が0件の場合の適切なフィードバック

## 8. 実装ガイドライン

### 8.1 推奨される技術スタック

- フレームワーク: Streamlit
- データベース: SQLite
- ORM: SQLAlchemy
- 全文検索: SQLite FTS5
- API通信: Google API Client
- マークダウンレンダリング: Streamlitネイティブのマークダウンサポート
- コードハイライト: Streamlit code blocks
- ファイルシステム操作: Pythonの標準ライブラリ
- エクスポート: Pandas（CSV出力用）

### 8.2 コーディング規約と設計パターン

- PEP 8に準拠したPythonコーディング規約
- モジュール化された設計
  - `app.py`: メインのStreamlitアプリケーション
  - `models/`: SQLAlchemyモデル定義
  - `database/`: データベース接続と操作
  - `services/`: ビジネスロジック
  - `api/`: Gemini API連携
  - `utils/`: ユーティリティ関数
- リポジトリパターンを用いたデータアクセスの抽象化
- サービス層でのビジネスロジックのカプセル化
- Streamlitセッション状態を活用した状態管理
- FTS5を使用した全文検索の実装
  - 半角スペースで区切られた単語のAND検索の実装
  - 検索結果のスレッドごとのグループ化
- マークダウンファイル操作の抽象化
  - トランザクション的な書き込み処理によるファイル整合性の保証
  - OSに依存しないファイルパス処理

### 8.3 テスト戦略と品質基準

- Pytestを使用したユニットテスト
- モックを使用したGemini API呼び出しのテスト
- データベース操作のテスト
- Streamlitコンポーネントの検証
- 80%以上のコードカバレッジを目指す
- Flake8およびBlackによるコード品質の維持

## 9. デプロイと実行

### 9.1 環境設定

- Python 3.9以上
- 必要なパッケージのrequirements.txt提供
- 環境変数設定方法のドキュメント（.env.exampleの提供）
- Gemini API Keyの取得と設定方法の説明

### 9.2 ローカル実行方法

```bash
# 仮想環境の作成と有効化
python -m venv venv
source venv/bin/activate  # Windowsの場合: venv\Scripts\activate

# 依存関係のインストール
pip install -r requirements.txt

# 環境変数の設定
cp .env.example .env
# .envファイルにGemini API Keyを設定

# アプリケーションの実行
streamlit run app.py
```

### 9.3 初期データセットアップ

- 初回起動時にデータベースの自動作成
- サンプルプロジェクトとシステムプロンプトの提供（オプション）
- マークダウンファイル保存ディレクトリの作成

## 10. Cursor AI開発支援プロンプト
