# Gemini検索対応チャットアプリケーション要件定義書

## 1. プロジェクト概要

### プロジェクト名

Gemini Search Chat

### 目的

Next.jsを使用してGemini APIで検索ができる個人用Webアプリケーションを開発し、OSSとして公開する。日常的な質問に対応するためのシンプルなインターフェースを提供する。

### 主要なステークホルダーと対象ユーザー

- 開発者自身
- このOSSを利用する他の開発者（インストールする人）

### プロジェクトの背景と解決すべき問題

- Gemini APIを使った検索機能を持つ自分用チャットアプリケーションの構築
- プロジェクト単位での会話コンテキスト管理
- カスタマイズ可能なシステムプロンプト設定
- 使用するGeminiモデルの切り替え機能
- 会話履歴の保存と管理
- 複数のスレッド（チャットセッション）の管理
- 会話履歴のエクスポート機能

### 成功基準と期待される結果

- シンプルで使いやすいUI/UX
- Next.js App Routerを使用した効率的な実装
- プロジェクト単位でのシステムプロンプト設定と会話管理
- **プロジェクト単位での使用モデル設定機能**
- 複数のスレッドで会話履歴を管理できる機能
- SQLiteによるローカルでのデータ保存
- 会話履歴を適切な形式でエクスポートできる機能

## 2. 機能要件

### 2.1 プロジェクト管理機能

- プロジェクトの作成、編集、削除
- プロジェクト一覧表示
- プロジェクト切り替え機能
- プロジェクトごとのシステムプロンプト設定
- プロジェクトごとのスレッド管理

### 2.2 スレッド管理機能

- プロジェクト内での新規スレッド（チャットセッション）の作成
- スレッド一覧の表示
- スレッドの選択と切り替え
- スレッドの削除
- スレッド名の編集
- 使用するGeminiモデルの切り替え機能
- スレッド(リクエスト)ごとの使用Geminiモデル設定（gemini-2.0-flash, gemini-2.0-pro-exp-02-05, gemini-2.5-pro-exp-03-25）

### 2.3 チャット機能

- テキスト入力によるGemini APIへの質問送信
- ブラウザのSpeech to Text API（Web Speech API）を使用した音声入力機能（Chrome推奨）
- プロジェクトごとのシステムプロンプトをコンテキストに適用
- **プロジェクトで設定されたGeminiモデルを使用**
- Gemini APIからの回答表示
- マークダウン形式での回答レンダリング
- コードブロックの適切な表示（シンタックスハイライト対応）
- 長文回答のスクロール表示

### 2.4 検索機能

- Gemini APIを用いた検索クエリの処理（プロジェクト設定モデルを使用）
- 検索結果の表示とマークダウン対応
- 検索の文脈を維持したチャット継続

### 2.5 履歴管理機能

- プロジェクト・スレッドごとの会話履歴の自動保存
  - SQLiteデータベースへの保存
  - マークダウンファイルへのリアルタイム書き出し（スレッドごとに1ファイル）
- 過去の会話履歴の閲覧
- マークダウンファイルの確認機能
- SQLite FTS5を使用したチャット履歴の全文検索機能
  - 半角スペースで区切られた複数キーワードによる検索
  - 複数キーワードを含むスレッドを検索可能

### 2.6 エクスポート機能

- 全データのCSV形式でのエクスポート
- 既存のマークダウンファイルの確認機能（スレッドごとのリアルタイム保存ファイル）

## 3. 非機能要件

### 3.1 パフォーマンス要件

- ページロード時間：2秒以内
- Gemini API応答待ち時間のローディング表示
- スムーズなスクロールとページ遷移

### 3.2 セキュリティ要件

- Gemini API キーの安全な管理
- ローカルのみで動作するアプリケーションのため、追加的な認証は不要

### 3.3 可用性と信頼性

- オフライン時のエラーハンドリング
- APIリクエスト失敗時の適切なエラーメッセージ表示
- データベース操作エラーの適切な処理
- 音声認識非対応ブラウザでの代替UI提供（音声入力ボタンの非表示または無効化）

### 3.4 スケーラビリティとメンテナンス性

- コンポーネントベースの設計による拡張性の確保
- 明確なコードドキュメントとコメント
- プロジェクト構成の整理と標準的なNext.jsの慣習に従った実装

## 4. アーキテクチャ設計

### 4.1 システム構成図

```
+---------------------+     +----------------+     +------------------+
| Next.js Application |<--->| Drizzle ORM    |<--->| SQLite Database  |
| (Frontend/Backend)  |     | (Data Access)  |     | (Local Storage)  |
+---------------------+     +----------------+     +------------------+
        |                          |                        |
        |                          v                        |
        |                   +----------------+              |
        |                   | SQLite FTS5    |<-------------+
        |                   | Search Engine  |
        |                   +----------------+
        v
+---------------------+     +------------------+
| File System         |     | Gemini API       |
| (Markdown Files)    |     | (External Service)|
+---------------------+     +------------------+
```

### 4.2 コンポーネント間の依存関係

- Next.js App RouterがフロントエンドとAPIルートを提供
- APIルートがGemini APIとの通信を処理
- データアクセスレイヤーがSQLiteデータベースとの通信を担当
- エクスポートサービスがファイルシステムへの書き出しを担当

### 4.3 外部システムとのインターフェース

- Gemini API: REST APIを使用して検索クエリを送信し結果を受信

## 5. データモデル

### 5.1 ER図

```
+----------------+       +-----------------+       +-------------------+       +-------------------+
| Project        |       | Thread          |       | Message           |       | MessageFTS        |
+----------------+       +-----------------+       +-------------------+       +-------------------+
| id (PK)        |<------| id (PK)         |<----->| id (PK)           |<----->| rowid (PK)        |
| name           |       | project_id (FK) |       | thread_id (FK)    |       | content           |
| system_prompt  |       | name            |       | role              |       +-------------------+
| created_at     |       | created_at      |       | content           |
| updated_at     |       | updated_at      |       | created_at        |
+----------------+       +-----------------+       +-------------------+
```

### 5.2 データディクショナリ

#### Project テーブル (Drizzle Schema)

| フィールド名    | 型      | 制約        | 説明                      |
|---------------|---------|------------|--------------------------|
| id            | INTEGER | PRIMARY KEY| プロジェクトの一意識別子      |
| name          | TEXT    | NOT NULL   | プロジェクト名              |
| system_prompt | TEXT    | NOT NULL   | システムプロンプト設定       |
| created_at    | TEXT    | NOT NULL   | 作成日時（ISO形式の文字列）   |
| updated_at    | TEXT    | NOT NULL   | 更新日時（ISO形式の文字列）   |

#### Thread テーブル (Drizzle Schema)

| フィールド名 | 型      | 制約                      | 説明                      |
|------------|---------|--------------------------|--------------------------|
| id         | INTEGER | PRIMARY KEY              | スレッドの一意識別子          |
| project_id | INTEGER | FOREIGN KEY (Project.id) | 所属するプロジェクトのID       |
| name       | TEXT    | NOT NULL                 | スレッド名                  |
| created_at | TEXT    | NOT NULL                 | 作成日時（ISO形式の文字列）    |
| updated_at | TEXT    | NOT NULL                 | 更新日時（ISO形式の文字列）    |

#### Message テーブル (Drizzle Schema)

| フィールド名 | 型      | 制約                      | 説明                      |
|------------|---------|--------------------------|--------------------------|
| id         | INTEGER | PRIMARY KEY              | メッセージの一意識別子        |
| thread_id  | INTEGER | FOREIGN KEY (Thread.id)  | 所属するスレッドのID         |
| role       | TEXT    | NOT NULL                 | メッセージの役割（'user'/'assistant'/'system'）|
| content    | TEXT    | NOT NULL                 | メッセージの内容             |
| created_at | TEXT    | NOT NULL                 | 作成日時（ISO形式の文字列）    |

#### MessageFTS テーブル (SQLite FTS5仮想テーブル)

| フィールド名 | 型      | 制約        | 説明                      |
|------------|---------|------------|--------------------------|
| rowid      | INTEGER | 暗黙的PK     | Message.idと連動する識別子   |
| content    | TEXT    | INDEXED    | 全文検索対象のメッセージ内容   |

### 5.3 データの流れと処理

1. ユーザーがプロジェクトを作成/選択
2. プロジェクト内でスレッドを作成/選択
3. ユーザーがメッセージを入力
4. メッセージがデータベースに保存され、プロジェクトのシステムプロンプトとともにGemini APIに送信
5. 同時に、スレッド専用のマークダウンファイルにメッセージが追記される
6. Gemini APIからの応答がデータベースに保存され、UI上に表示
7. 同様に、マークダウンファイルにGemini APIの応答も追記される
8. 保存されたメッセージはFTS5インデックスにも追加され、検索可能に
9. ユーザーが検索を実行すると、FTS5インデックスを使用して関連メッセージを抽出
10. 「ファイルを確認」ボタンでスレッドに対応するマークダウンファイルを表示/開く
11. 全データエクスポート時にはデータベースからデータを取得し、CSV形式に変換して出力

## 6. ユーザーインターフェース

### 6.1 画面遷移図

```
[ホーム画面(プロジェクト一覧)] --> [プロジェクト画面] --> [チャット画面]
            ^                          ^               |
            |                          |               v
[設定画面] ---+                  [システムプロンプト設定] <--+
```

### 6.2 各画面の主要要素と機能

#### ホーム画面（プロジェクト一覧）

- プロジェクト一覧表示
- 新規プロジェクト作成ボタン
- プロジェクト検索/フィルターフォーム
- 設定ボタン

#### プロジェクト画面

- プロジェクト名表示
- プロジェクト編集ボタン（システムプロンプト設定など）
- スレッド一覧表示
- 新規スレッド作成ボタン
- 検索ボタン/フォーム
- プロジェクト一覧に戻るボタン

#### システムプロンプト設定画面

- プロジェクト名入力フォーム
- システムプロンプト入力フォーム（マークダウンエディタ）
- プリセットテンプレート選択オプション
- 保存ボタン
- キャンセルボタン

#### チャット画面

- プロジェクト名表示
- スレッド名表示
- メッセージ履歴表示領域（スクロール可能）
- メッセージ入力フォーム
- 送信ボタン
- 音声入力ボタン（録音開始/停止）
- 音声認識状態表示（録音中、処理中、完了）
- スレッド一覧に戻るボタン
- マークダウンファイルを確認するボタン

#### 検索画面

- 検索キーワード入力フォーム
- 検索範囲選択（全プロジェクト/現在のプロジェクト）
- 検索実行ボタン
- 検索結果一覧（プロジェクト名、スレッド名、日付、メッセージプレビュー付き）
- 検索結果をクリックして該当スレッドとメッセージを表示

#### 設定画面

- Gemini API設定
- 全データエクスポートボタン（CSV形式）
- データリセットボタン
- マークダウンファイル保存ディレクトリ設定
- バージョン情報

### 6.3 ユーザー操作フロー

1. ホーム画面でプロジェクトを選択または新規作成
2. 新規プロジェクト作成時はシステムプロンプトを設定
3. プロジェクト画面でスレッドを選択または新規作成
4. チャット画面でメッセージを入力（テキスト入力または音声入力）
   - テキスト入力の場合：テキストエリアに直接入力
   - 音声入力の場合：音声入力ボタンをクリックして録音開始→話す→自動または手動で録音停止→テキストに変換
5. 送信ボタンをクリックしてメッセージを送信（プロジェクトのシステムプロンプトが自動的に適用される）
6. 応答を確認し、必要に応じて会話を継続
7. 必要に応じて「マークダウンファイルを確認」ボタンでスレッドの履歴ファイルを表示/開く
8. 同一プロジェクト内で新しいスレッドに切り替え、または別のプロジェクトに移動
9. 検索機能を使用して過去の会話を検索
10. 設定画面にアクセスして各種設定を変更

## 7. インターフェース仕様

### 7.1 API仕様

#### 内部API

##### プロジェクト関連

- `GET /api/projects` - プロジェクト一覧取得
- `POST /api/projects` - 新規プロジェクト作成
- `GET /api/projects/:id` - プロジェクト取得
- `PUT /api/projects/:id` - プロジェクト更新（システムプロンプト設定を含む）
- `DELETE /api/projects/:id` - プロジェクト削除

##### スレッド関連

- `GET /api/projects/:projectId/threads` - プロジェクト内スレッド一覧取得
- `POST /api/projects/:projectId/threads` - プロジェクト内に新規スレッド作成
- `PUT /api/projects/:projectId/threads/:id` - スレッド更新
- `DELETE /api/projects/:projectId/threads/:id` - スレッド削除

##### メッセージ関連

- `GET /api/threads/:threadId/messages` - スレッド内メッセージ取得
- `POST /api/threads/:threadId/messages` - 新規メッセージ送信

##### マークダウンファイル関連

- `GET /api/threads/:threadId/markdown` - スレッドのマークダウンファイルを取得
- `GET /api/threads/:threadId/open-markdown` - スレッドのマークダウンファイルをOSのデフォルトアプリで開く

##### 検索関連

- `GET /api/search?q=:query&projectId=:projectId` - チャット履歴の全文検索（プロジェクト指定可）
- `GET /api/search/threads/:threadId?q=:query` - 特定スレッド内での全文検索

##### 設定関連

- `GET /api/settings` - 設定取得
- `PUT /api/settings` - 設定更新
- `POST /api/export` - 全データエクスポート（CSV形式）

#### 外部API (Gemini)

- Gemini API呼び出し
  - エンドポイント: `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent`
  - メソッド: POST
  - ヘッダー: API Keyを含む
  - リクエストボディ: チャットメッセージ履歴を含むJSON

### 7.2 外部システムとの連携仕様

- Gemini APIと通信するためのHTTPクライアント実装
  - システムプロンプトの適切な組み込み処理
  - 会話履歴の管理
- API Keyを.envファイルまたは環境変数から読み込む仕組み
- ファイルシステムとの連携
  - マークダウンファイルの作成と更新
  - OSのデフォルトアプリでのファイルオープン処理

### 7.3 エラーハンドリングと例外処理

- API通信エラー時の再試行ロジック
- ユーザーへのエラー通知メカニズム
- データベースエラーのロギングと回復処理
- 検索クエリ構文エラーの適切な処理と通知
- 検索結果が0件の場合の適切なフィードバック

## 8. UMLダイアグラム

### 8.1 ユースケース図

```
[ユーザー] --- (プロジェクトを作成する)
[ユーザー] --- (プロジェクトを選択する)
[ユーザー] --- (システムプロンプトを設定する)
[ユーザー] --- (スレッドを作成する)
[ユーザー] --- (スレッドを選択する)
[ユーザー] --- (メッセージを送信する)
[ユーザー] --- (応答を確認する)
[ユーザー] --- (チャット履歴を検索する)
[ユーザー] --- (検索結果を確認する)
[ユーザー] --- (スレッドの履歴をエクスポートする)
[ユーザー] --- (全データをエクスポートする)
[ユーザー] --- (設定を変更する)
```

### 8.2 シーケンス図（チャット処理フロー）

```
ユーザー -> UI: メッセージ入力
UI -> API Routes: POST /api/threads/:threadId/messages
API Routes -> Drizzle ORM: プロジェクトのシステムプロンプト取得
API Routes -> Drizzle ORM: メッセージを保存(user)
Drizzle ORM -> データベース: SQLを実行
Drizzle ORM -> FTS5: 全文検索インデックスを更新
API Routes -> ファイルシステム: マークダウンファイルにユーザーメッセージを追記
API Routes -> Gemini API: システムプロンプト、メッセージ、コンテキストを送信
Gemini API -> API Routes: 応答
API Routes -> Drizzle ORM: メッセージを保存(assistant)
Drizzle ORM -> データベース: SQLを実行
Drizzle ORM -> FTS5: 全文検索インデックスを更新
API Routes -> ファイルシステム: マークダウンファイルにアシスタント応答を追記
API Routes -> UI: 応答を返す
UI -> ユーザー: 応答を表示
```

### 8.2.2 シーケンス図（マークダウンファイル確認フロー）

```
ユーザー -> UI: マークダウンファイルを確認ボタンをクリック
UI -> API Routes: GET /api/threads/:threadId/open-markdown
API Routes -> ファイルシステム: マークダウンファイルパスを取得
API Routes -> OS: デフォルトアプリでファイルを開く
OS -> ユーザー: マークダウンファイルを表示
```

### 8.2.3 シーケンス図（音声入力フロー）

```
ユーザー -> UI: 音声入力ボタンをクリック
UI -> ブラウザ: Web Speech API 録音開始
UI -> ユーザー: 録音状態表示（アイコン変更、状態表示）
ユーザー -> ブラウザ: 音声入力
ブラウザ -> ブラウザ: 音声認識処理
ブラウザ -> UI: 認識結果テキスト
UI -> ユーザー: 入力フォームにテキスト表示
ユーザー -> UI: 必要に応じてテキスト編集
ユーザー -> UI: 送信ボタンをクリック（通常のチャットフローへ）
```

### 8.2.4 シーケンス図（システムプロンプト設定フロー）

```
ユーザー -> UI: プロジェクト作成/編集画面にアクセス
UI -> ユーザー: プロジェクト情報入力フォームを表示
ユーザー -> UI: プロジェクト名とシステムプロンプトを入力
ユーザー -> UI: 保存ボタンをクリック
UI -> API Routes: POST/PUT /api/projects
API Routes -> Drizzle ORM: プロジェクト情報を保存
Drizzle ORM -> データベース: SQLを実行
API Routes -> UI: 保存完了応答
UI -> ユーザー: プロジェクト一覧に戻る
```

### 8.3 コンポーネント図

```
+-------------------+   +-------------------+   +------------------+
| UI Components     |-->| API Routes        |-->| Data Access Layer|
| - ProjectList     |   | - projectRoutes   |   | - Drizzle Schema |
| - ProjectEditor   |   | - threadRoutes    |   | - projectRepository|
| - ThreadList      |   | - messageRoutes   |   | - threadRepository|
| - ChatView        |   | - markdownRoutes  |   | - messageRepository|
| - MessageInput    |   | - searchRoutes    |   | - searchRepository|
| - SpeechInput     |   | - settingsRoutes  |   +------------------+
| - SearchView      |   +-------------------+          |
| - Settings        |           |                      v
+-------------------+           v               +------------------+
        ^                +-------------------+  | Database         |
        |                | Service Layer     |  | - SQLite         |
        +----------------| - projectService  |  | - FTS5           |
                         | - chatService     |  +------------------+
                         | - searchService   |
                         | - exportService   |
                         | - geminiService   |
                         | - markdownService |
                         | - speechService   |
                         +-------------------+
                                  |
                                  v
                +-------------------+   +------------------+   +------------------+
                | External          |   | File System     |   | Browser APIs     |
                | - Gemini API      |   | - Markdown Files|   | - Web Speech API |
                | - OS File Open    |   +------------------+   +------------------+
                +-------------------+
```

## 9. 実装ガイドライン

### 9.1 推奨される技術スタック

- フロントエンド: Next.js 14+ (App Router), React, TailwindCSS
- バックエンド: Next.js API Routes
- データベース: SQLite (better-sqlite3)
- ORM: Drizzle ORM (SQLite対応)
- 全文検索: SQLite FTS5 (半角スペースで区切られた複数単語検索対応)
- API通信: fetch または axios
- マークダウンレンダリング: react-markdown
- コードハイライト: prism.js または highlight.js
- 音声認識: Web Speech API (SpeechRecognition インターフェース)
- ファイルシステム操作: fs/promises, child_process (OSのデフォルトアプリ起動用)
- エクスポート: papaparse (CSV)

### 9.2 コーディング規約と設計パターン

- ディレクトリ構造は Next.js App Router の慣習に従う
- React コンポーネントは関数コンポーネントとして実装
- サーバーコンポーネントとクライアントコンポーネントの適切な使い分け
- データフェッチングはサーバーコンポーネントで行う
- フォームとユーザーインタラクションはクライアントコンポーネントで実装
- Drizzle ORMを使用したデータアクセス層の実装
- リポジトリパターンを用いたデータアクセスの抽象化
- サービス層でのビジネスロジックのカプセル化
- FTS5を使用した全文検索の実装
  - 半角スペースで区切られた単語のAND検索の実装
  - 検索結果のスレッドごとのグループ化
- マークダウンファイル操作の抽象化
  - トランザクション的な書き込み処理によるファイル整合性の保証
  - OSに依存しないファイルパス処理
- Web Speech APIの適切な実装
  - ブラウザ互換性チェック（主にChrome対応）
  - 音声認識状態の適切なフィードバック
  - 音声認識エラーハンドリング

### 9.3 テスト戦略と品質基準

- Jest を使用したユニットテスト
- React Testing Library を使用したコンポーネントテスト
- エンドツーエンドテストには Playwright を使用
- 80%以上のコードカバレッジを目指す
- Prettier と ESLint によるコード品質の維持

## 10. Cursor AI開発支援プロンプト

```
あなたは熟練したソフトウェアエンジニアとして、以下の要件定義に基づいて実装を行います。

# プロジェクト概要
Gemini Search Chat - Gemini APIを活用した個人用チャットアプリケーション。
Next.js（App Router）とSQLiteを使用して、プロジェクト単位でシステムプロンプトを設定し、
各プロジェクト内で複数のスレッドでチャット履歴を管理し、
検索機能と会話履歴のリアルタイム保存機能を提供します。

# 実装における指針
1. 上記の要件定義に厳密に従ってコードを実装してください
2. 各コンポーネントは疎結合になるよう設計し、保守性の高いコードを目指します
3. エラー処理を適切に実装し、エッジケースも考慮してください
4. コードにはドキュメンテーションコメントを適切に付与してください
5. テスト可能なコードを心がけ、必要に応じてユニットテストも実装してください

# 技術スタック
- フロントエンド: Next.js 14+ (App Router), React, TailwindCSS
- バックエンド: Next.js API Routes
- データベース: SQLite (better-sqlite3)
- ORM: Drizzle ORM (SQLite対応)
- 全文検索: SQLite FTS5 (半角スペースで区切られた複数単語検索対応)
- API通信: fetch または axios
- マークダウンレンダリング: react-markdown
- コードハイライト: prism.js または highlight.js
- 音声認識: Web Speech API (SpeechRecognition インターフェース、Chrome推奨)
- ファイルシステム操作: fs/promises, child_process (OSのデフォルトアプリ起動用)

# 実装プロセス
1. 要件を理解し、必要に応じて質問します
2. アーキテクチャと主要コンポーネントの設計を提案します
3. 段階的に実装を進め、各段階で進捗を報告します
4. コードレビューのフィードバックを受け入れ、継続的に改善します

このプロジェクトの実装を通じて、高品質で要件を満たすソフトウェアを構築することを目指します。
```
